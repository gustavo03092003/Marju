<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Pagamento - MarjuSousplat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      .top-bar {
        height: 50px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 0 20px;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header-icons i {
        font-size: 30px;
        color: #a0004d;
        margin-left: 15px;
        cursor: pointer;
      }

      .modal-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .modal-bg.active {
        display: flex;
      }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-pink-100 to-pink-300 min-h-screen flex flex-col"
  >
    <header
      class="flex items-center px-8 py-0 bg-transparent w-full max-w-6xl mx-auto h-[90px]"
    >
      <img src="/assets/Logo2.png" alt="Logo" class="h-72 max-w-none" />
      <div class="flex-1"></div>
      <header class="main-banner">
        <div class="header-icons top-bar" style="position: relative">
          <a href="produtos.html"><i class="fas fa-home"></i></a>
          <a href="javascript:void(0);" id="user-icon"
            ><i class="fas fa-user"></i
          ></a>
          <a href="pagamento.html"><i class="fas fa-shopping-cart"></i></a>
          <div
            id="user-menu"
            class="hidden absolute right-0 mt-2 w-40 bg-white rounded shadow-lg z-50"
          >
            <button
              id="go-account"
              class="block w-full text-left px-4 py-2 hover:bg-pink-100 text-pink-700"
            >
              Minha Conta
            </button>
            <button
              id="logout-btn"
              class="block w-full text-left px-4 py-2 hover:bg-pink-100 text-red-500"
            >
              Sair
            </button>
          </div>
        </div>
      </header>
    </header>
    <main class="flex-1 flex flex-col items-center justify-center">
      <div
        class="w-full max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6 px-4 py-8"
      >
        <div class="flex flex-col gap-4 md:col-span-1 h-full">
          <div class="bg-pink-100 rounded-xl p-4 flex flex-col gap-2 shadow">
            <h2 class="text-pink-600 text-2xl font-bold mb-2 text-center">
              Identifique-se
            </h2>
            <div id="user-info" class="text-gray-700 text-sm"></div>
          </div>
          <div
            class="bg-pink-100 rounded-xl p-6 flex flex-col gap-2 shadow flex-1 justify-start"
          >
            <h2 class="text-pink-600 text-2xl font-bold mb-2 text-center">
              Entrega
            </h2>
            <div class="text-gray-700 text-sm">
              <span class="font-bold">Endereço para entrega:</span><br />
              Rua das Rosas - 4 - Centro<br />
              Complemento: Apt 201<br />
              Cataguases - MG<br />
              CEP 36770-000
              <br /><br />
              <span class="font-bold">Forma de Entrega:</span><br />
              Padrão Econômico - R$ 28.00<br />
              <span class="text-xs text-gray-500">(até 10 dias úteis)</span>
            </div>
          </div>
        </div>
        <div
          class="bg-pink-100 rounded-xl p-6 flex flex-col gap-4 shadow md:col-span-2"
        >
          <h2 class="text-pink-600 text-2xl font-bold mb-2 text-center">
            Resumo
          </h2>
          <div class="flex items-center gap-2">
            <input
              type="text"
              placeholder="CÓDIGO"
              class="flex-1 rounded-lg px-3 py-2 border border-gray-300 focus:outline-pink-400"
            />
            <button class="text-pink-600 font-bold hover:underline">
              Adicionar
            </button>
          </div>
          <textarea
            placeholder="Observação da compra"
            class="rounded-lg px-3 py-2 border border-gray-300 focus:outline-pink-400 resize-none h-16"
          ></textarea>
          <div class="text-gray-700 text-base">
            <div class="flex justify-between">
              <span>Produtos:</span>
              <span class="resumo-produtos">R$ 0,00</span>
            </div>
            <div class="flex justify-between">
              <span>Descontos:</span>
              <span class="resumo-descontos">R$ 1,99</span>
            </div>
            <div class="flex justify-between">
              <span>Frete:</span> <span class="resumo-frete">R$28,00</span>
            </div>
            <div class="flex justify-between font-bold text-lg mt-2">
              <span>Total:</span>
              <span class="resumo-total text-green-600">R$ 0,00</span>
            </div>
          </div>
          <div id="produtos-lista"></div>
        </div>
        <div
          class="bg-pink-100 rounded-xl p-6 flex flex-col gap-4 shadow md:col-span-1"
        >
          <h2 class="text-pink-600 text-2xl font-bold mb-2 text-center">
            Pagamento
          </h2>
          <div class="text-gray-700 mb-2 text-center">
            Escolha uma Forma de Pagamento:
          </div>
          <form class="flex flex-col gap-4" onsubmit="finalizarPedido(event)">
            <label
              class="flex items-center bg-white rounded-lg px-4 py-3 cursor-pointer border border-gray-200"
            >
              <input
                type="radio"
                name="pagamento"
                class="form-radio text-pink-600 mr-3"
              />
              <span class="text-lg">Cartão de Crédito</span>
            </label>
            <label
              class="flex items-center bg-white rounded-lg px-4 py-3 cursor-pointer border border-gray-200"
            >
              <input
                type="radio"
                name="pagamento"
                class="form-radio text-pink-600 mr-3"
              />
              <span class="text-lg">PIX</span>
            </label>
            <label
              class="flex items-center bg-white rounded-lg px-4 py-3 cursor-pointer border border-gray-200"
            >
              <input
                type="radio"
                name="pagamento"
                checked
                class="form-radio text-pink-600 mr-3"
              />
              <span class="text-lg">Boleto</span>
            </label>
            <button
              type="submit"
              class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg transition"
            >
              Finalizar compra
            </button>
          </form>
        </div>
      </div>
    </main>

    <div id="cart-modal-bg" class="modal-bg">
      <div class="bg-white rounded-lg shadow-lg p-6 w-80 relative">
        <button
          onclick="closeCart()"
          class="absolute top-2 right-2 text-gray-400 hover:text-pink-500 text-xl"
        >
          &times;
        </button>
        <h2 class="text-lg font-bold mb-4 text-pink-700">
          Carrinho de Compras
        </h2>
        <div id="cart-items" class="mb-4 text-left text-gray-700">
          Você não tem itens no carrinho.
        </div>
        <button
          onclick="redirectToPayment()"
          class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600 transition mb-2"
        >
          Finalizar Compra
        </button>
        <button
          onclick="closeCart()"
          class="w-full bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300 transition"
        >
          Fechar
        </button>
      </div>
    </div>

    <script>
      const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
      const cartKey = usuario ? "marju_cart_" + usuario.cpf : "marju_cart";
      let cart = JSON.parse(localStorage.getItem(cartKey)) || [];

      function updateCartCount() {
        const count = cart.reduce((sum, item) => sum + item.qtd, 0);
        const itemCount = document.getElementById("item-count");
        if (itemCount) itemCount.innerText = count;
      }

      function updateCartModal() {
        const cartItemsDiv = document.getElementById("cart-items");
        if (!cartItemsDiv) return;
        if (cart.length === 0) {
          cartItemsDiv.innerHTML = "Você não tem itens no carrinho.";
          return;
        }
        let html = '<ul class="mb-2">';
        let total = 0;
        cart.forEach((item, idx) => {
          total += item.qtd * item.preco;
          html += `
            <li class="flex items-center justify-between mb-2">
              <div class="flex items-center">
                <img src="${item.img}" alt="${
            item.nome
          }" class="w-10 h-10 rounded mr-2 border" />
                <span>${item.nome}</span>
              </div>
              <div>
                <button onclick="changeQtd(${idx}, -1)" class="px-2 text-pink-500 font-bold">-</button>
                <span>${item.qtd}</span>
                <button onclick="changeQtd(${idx}, 1)" class="px-2 text-pink-500 font-bold">+</button>
              </div>
              <span class="ml-2">R$ ${(item.preco * item.qtd).toFixed(2)}</span>
            </li>
          `;
        });
        html += `</ul>
          <div class="font-bold text-right text-pink-700">Total: R$ ${total.toFixed(
            2
          )}</div>`;
        cartItemsDiv.innerHTML = html;
      }

      function changeQtd(idx, delta) {
        cart[idx].qtd += delta;
        if (cart[idx].qtd <= 0) cart.splice(idx, 1);
        localStorage.setItem(cartKey, JSON.stringify(cart));
        updateCartCount();
        updateCartModal();
      }

      function openCart() {
        cart = JSON.parse(localStorage.getItem(cartKey)) || [];
        document.getElementById("cart-modal-bg").classList.add("active");
        document.body.style.overflow = "hidden";
        updateCartModal();
      }

      function closeCart() {
        document.getElementById("cart-modal-bg").classList.remove("active");
        document.body.style.overflow = "";
      }

      function redirectToPayment() {
        window.location.href = "pagamento.html";
      }

      if (!document.getElementById("item-count")) {
        const cartIcon = document.querySelector(
          ".header-icons .fa-shopping-cart"
        );
        if (cartIcon) {
          const span = document.createElement("span");
          span.id = "item-count";
          span.className =
            "absolute -top-2 -right-3 bg-pink-500 text-white text-xs rounded-full px-2";
          span.innerText = cart.reduce((sum, item) => sum + item.qtd, 0);
          cartIcon.parentElement.style.position = "relative";
          cartIcon.parentElement.appendChild(span);
        }
      }

      const cartIconBtn =
        document.getElementById("cart-icon") ||
        document.querySelector(".header-icons .fa-shopping-cart")
          ?.parentElement;
      if (cartIconBtn) {
        cartIconBtn.addEventListener("click", function (e) {
          e.preventDefault();
          openCart();
        });
      }

      function formatPrice(valor) {
        return "R$ " + valor.toFixed(2).replace(".", ",");
      }

      function getCart() {
        try {
          return JSON.parse(localStorage.getItem(cartKey)) || [];
        } catch {
          return [];
        }
      }

      function renderCart() {
        const cart = getCart();
        let produtosTotal = 0;
        let desconto = 1.99;
        let frete = 28.0;
        let totalQtd = 0;

        cart.forEach((item) => {
          produtosTotal += item.preco * item.qtd;
          totalQtd += item.qtd;
        });

        document
          .querySelectorAll(".resumo-produtos")
          .forEach((el) => (el.textContent = formatPrice(produtosTotal)));
        document
          .querySelectorAll(".resumo-descontos")
          .forEach((el) => (el.textContent = formatPrice(desconto)));
        document
          .querySelectorAll(".resumo-frete")
          .forEach((el) => (el.textContent = formatPrice(frete)));
        document
          .querySelectorAll(".resumo-total")
          .forEach(
            (el) =>
              (el.textContent = formatPrice(produtosTotal - desconto + frete))
          );

        const produtosDiv = document.getElementById("produtos-lista");
        produtosDiv.innerHTML = "";
        cart.forEach((item) => {
          const div = document.createElement("div");
          div.className =
            "flex items-center gap-3 mt-4 bg-white rounded-lg p-3 border border-gray-200";
          div.innerHTML = `
            <img src="${item.img}" alt="${
            item.nome
          }" class="w-16 h-16 object-cover rounded-lg border border-gray-200" />
            <div class="flex-1">
              <div class="font-semibold text-sm">
                ${item.nome}<br>
                <span class="text-xs text-gray-500">${item.tamanho || ""} ${
            item.cor ? "- " + item.cor : ""
          }</span>
              </div>
              <div class="flex items-center gap-2 mt-1">
                <span class="text-xs">Qtd: ${item.qtd}</span>
                <span class="font-bold text-pink-600 text-sm">${formatPrice(
                  item.preco
                )}</span>
              </div>
            </div>
          `;
          produtosDiv.appendChild(div);
        });
      }
      window.addEventListener("DOMContentLoaded", () => {
        const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
        if (usuario) {
          document.getElementById("user-info").innerHTML = `
            <div><strong>Nome:</strong> ${usuario.nome}</div>
            <div><strong>Email:</strong> ${usuario.email}</div>
            <div><strong>CPF:</strong> ${formatCPF(usuario.cpf)}</div>
          `;

          const entregaDiv = document.querySelector(
            ".bg-pink-100.p-6.flex.flex-col.gap-2.shadow.flex-1.justify-start .text-gray-700.text-sm"
          );
          if (usuario.endereco && usuario.endereco.rua) {
            const endereco = usuario.endereco;
            entregaDiv.innerHTML = `
              <span class="font-bold">Endereço para entrega:</span>
              ${endereco.rua}, ${endereco.numero}
              ${endereco.complemento ? "- " + endereco.complemento : ""}<br />
              ${endereco.cidade} - ${endereco.estado}<br />
              CEP ${endereco.cep}
              <br /><br />
              <span class="font-bold">Forma de Entrega:</span><br />
              Padrão Econômico - R$ 28.00<br />
              <span class="text-xs text-gray-500">(até 10 dias úteis)</span>
            `;
          } else {
            entregaDiv.innerHTML = `
              <span class="font-bold">Endereço para entrega:</span>
              <span class="text-red-500 ml-2">Nenhum endereço cadastrado</span>
              <br /><br />
              <span class="font-bold">Forma de Entrega:</span><br />
              Padrão Econômico - R$ 28.00<br />
              <span class="text-xs text-gray-500">(até 10 dias úteis)</span>
            `;
          }
        } else {
          window.location.href = "login.html";
        }

        renderCart();
      });

      function formatCPF(cpf) {
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
      }

      function finalizarPedido(e) {
        if (e) e.preventDefault();

        const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
        if (!usuario || !usuario.endereco || !usuario.endereco.rua) {
          alert(
            "Por favor, insira um endereço de entrega antes de finalizar a compra."
          );
          return;
        }

        const cart = JSON.parse(localStorage.getItem(cartKey)) || [];
        if (!cart.length) return;

        const total =
          cart.reduce((s, i) => s + i.preco * i.qtd, 0) - 1.99 + 28.0;

        const pedido = {
          data: new Date().toISOString(),
          itens: cart,
          total,
          usuario: usuario,
        };

        const pedidosKey = "marju_pedidos_" + usuario.cpf;
        let pedidos = [];
        try {
          pedidos = JSON.parse(localStorage.getItem(pedidosKey)) || [];
        } catch {
          pedidos = [];
        }
        pedidos.unshift(pedido);
        localStorage.setItem(pedidosKey, JSON.stringify(pedidos));
        localStorage.removeItem(cartKey);

        alert("Pedido realizado com sucesso!");
        window.location.href = "produtos.html";
      }

      document
        .getElementById("go-account")
        .addEventListener("click", function () {
          window.location.href = "minha-conta.html";
        });

      document
        .getElementById("logout-btn")
        .addEventListener("click", function () {
          localStorage.removeItem("usuarioLogado");
          window.location.href = "login.html";
        });

      document
        .getElementById("user-icon")
        .addEventListener("click", function (e) {
          e.preventDefault();
          const menu = document.getElementById("user-menu");
          menu.classList.toggle("hidden");
        });

      document.addEventListener("click", function (e) {
        const menu = document.getElementById("user-menu");
        const icon = document.getElementById("user-icon");
        if (
          !menu.contains(e.target) &&
          e.target !== icon &&
          !icon.contains(e.target)
        ) {
          menu.classList.add("hidden");
        }
      });

      document
        .getElementById("go-account")
        .addEventListener("click", function () {
          window.location.href = "minha-conta.html";
        });

      document
        .getElementById("logout-btn")
        .addEventListener("click", function () {
          localStorage.removeItem("usuarioLogado");
          window.location.href = "login.html";
        });
    </script>
  </body>
</html>
